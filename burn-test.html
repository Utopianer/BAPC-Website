<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="BoredApePizzaClub" />
    <meta
      name="description"
      content="Mint your FREE Infinity Pizza here. A Polygon based NFT that gives access to the upcoming private Sale!"
    />
    <meta
      name="keywords"
      content="Blockchain, Ethereum, Polygon, nft, bayc, boredpizzas, freenft, freemint, nftcommunity"
    />
    <title>BoredPizzas | Burn</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/minireset.css/0.0.2/minireset.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/burn.css?v=1.0.3" />
  </head>
  <body class="burnPage">
    <div class="bodyWrapper">
      <header class="burn">
        <div><a href="/" class="backLink">Back</a></div>
        <div><img src="./img/logo.png" alt="" /></div>
        <div><button id="connectWallet" class="btn" onClick="connectWallet();">Connect Wallet</a></div>
      </header>
      <h1 class="burn">Burn Oven</h1>
      <div id="ovenContainer">
        <div id="inventory">
          <h2 class="burnHeading">Your Inventory</h2>
          <div id="inventoryContainer">
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
            <div class="inventoryItem placeholder"></div>
          </div>
          <div id="inventoryTotal">
            <div>Total Value in XYZ:</div>
            <div>
              <img src="img/BAPC-coin.svg" alt="BAPC Coin" />
              <span id="totalValue"></span>
            </div>
          </div>
        </div>
        <div id="videoWrapper">
          <video width="320" height="240" controls>
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
            <source src="https://www.w3schools.com/html/mov_bbb.ogg" type="video/ogg">
            Your browser does not support the video tag.
          </video>
          <button id="burnPizza" class="btn">Burn</a>
        </div>
        <div id="burn">
          <h2 class="burnHeading">Burn</h2>
          <table>
            <thead>
              <tr>
                <th></th>
                <th>Name</th>
                <th>Amount</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              
            </tbody>
          </table>
        </div>
      </div>
      <!-- Copy Right Text -->
      <div class="copyRightText" tkey="copy_text">&copy; 2022 Made with ‚ù§ by BAPC</div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js"></script>
    
    <!-- Web3 Injection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.5.2/web3.min.js" integrity="sha512-mYc+D+NmmyR0Gcrzyae7q5HguBCS4cBHAsIk7gGhu0/ZyGg4z2YZDjyR2YQA/IMCMTNs4mnlw3vVdERzewpekQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- ABI files -->
    <script src="js/coinabi.js"></script>
    <script src="js/pizzaabi.js"></script>
    <script src="js/ovenabi.js"></script>
    <script src="js/pizzalib.js"></script>
    
    <!-- page script starts here -->
    <script>
      var wallets = null;
      var web3 = null;
      var holdings = [];
      const PIZZA = '0x2953399124F0cBB46d2CbACD8A89cF0599974963'; //OpenSea ERC1155
      const PIZZA_ABI = top.abi_pizza;
      const COIN = ''; //Coin address
      const COIN_ABI = top.abi_coin;
      const OVEN = ''; //Oven address
      const OVEN_ABI = top.abi_oven;      
      const LIBRARY = top.pizzalib;
      const FINNEY = 1000000000000000;
      
      async function connectWallet() {
        // CONNECT TO USER WALLET
    	await window.ethereum.enable();
    	web3 = new Web3(window.ethereum);
    	wallets = await web3.eth.getAccounts();
    	
    	// VERIFY CORRECT CHAIN LOADED IN WALLET OR REQUEST CHANGE NETWORK
    	let chainId = await web3.eth.getChainId();    
    	if (chainId != 137){
    	  await window.ethereum.request({
    	    method: 'wallet_switchEthereumChain',
    	    params: [{chainId: '0x89'}],
    	  });
    	  window.location.reload();
    	}
    	
    	//PULL PIZZA DATA AND STORE IT LOCALLY
    	await getUserPizzas();
    	
    	// ADD PAGE UPDATE CODE AFTER WALLET CONNECT HERE
      }
      
      async function getUserPizzas() {
        holdings = []; //The holdings ID list stays consistent with our pizza library file
        let jlength = LIBRARY.length
        let walletarray = [];
        let tokenidarray = [];
          
        for (i=0; i<jlength; i++){
          
          tokenidarray.push(LIBRARY[i]['tokenid']);
          walletarray.push(wallets[0]);
          
        }
        
        var txn = new web3.eth.Contract(PIZZA_ABI, PIZZA);
        holdings = await txn.methods.balanceOfBatch( walletarray, tokenidarray ).call();
        
        // clear placeholders
        inventoryContainer.innerHTML = '';
        // init value
        let totalValue = 0;
        for (const [i, quantity] of holdings.entries()) {
          // if token is held
          if (quantity !== '0') {
            let tokenName = LIBRARY[i]['name'],
                imageName = tokenName.replace(/\s+/g, '-').toLowerCase(),
                value = LIBRARY[i]['price'],
                img = document.createElement('img'),
                span = document.createElement('span'),
                div = document.createElement('div');

            // build out inventory item
            div.classList.add('inventoryItem');
            // add data attributes
            div.dataset.tokenName = tokenName;
            div.dataset.imageName = imageName;
            div.dataset.quantity = quantity;
            div.dataset.value = value / 1000;
            div.dataset.index = i;
            // specify image path
            img.src = 'img/pizzas/'+imageName+'.jpg';

            // build out value span
            span.classList.add('quantity');
            span.textContent = quantity;

            // increment total value
            totalValue += (value * quantity) / 1000;

            div.appendChild(img);
            div.appendChild(span);

            inventoryContainer.appendChild(div);
          }
        }

        $totalValue = document.getElementById('totalValue');
        $totalValue.innerHTML = totalValue.toLocaleString();
      }

      $(function() {
        // Build out burn table
        $(document).on('click', '.inventoryItem:not(.placeholder):not(.disabled)', function() {
          const $this = $(this);
          $this.addClass('disabled');

          // get token values
          const name = $this.attr('data-token-name');
          const image = $this.attr('data-image-name');
          const quantity = $this.attr('data-quantity');
          const value = $this.attr('data-value');
          const index = $this.attr('data-index');

          // build out table row
          const $tableRow = `
            <tr data-index="${index}" data-value="${value}" data-quantity="${quantity}">
              <td><img src="img/pizzas/${image}.jpg" alt="${name}"></td>
              <td>${name} Pizza</td>
              <td><span class="add ${quantity == 1 ? 'disabled' : ''}">+</span><span class="quantity">1</span><span class="sub">-</span></td>
              <td class="value"><span></span>${value}</td>
            </tr>
          `;

          $('#burn table tbody').prepend($tableRow);
        });

        $(document).on('click', 'span.add:not(.disabled), span.sub', function() {
          const $this = $(this);
          const $tableRow = $this.closest('tr');
          const quantity = parseInt($tableRow.attr('data-quantity'));
          const value = parseFloat($tableRow.attr('data-value'));
          const index = $tableRow.attr('data-index');
          let amount = parseInt($('.quantity', $tableRow).text());
          let totalValue = value;
          if ($this.hasClass('add')) {
            amount++;
            if (amount === quantity) {
              $this.addClass('disabled');
            }
          } else {
            amount--;
            $('span.add', $tableRow).removeClass('disabled');
            if (amount === 0) {
              $tableRow.remove();
              $('.inventoryItem[data-index="'+index+'"]').removeClass('disabled');
            }
          }

          totalValue = (amount * value);
          $('.quantity', $tableRow).text(amount);
          $('.value', $tableRow).text(totalValue);
        });
      });
      
    </script>

  </body>
</html>
